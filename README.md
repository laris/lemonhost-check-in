# tgstate-python

<p align="center">
  <b>åŸºäº Telegram çš„æ— é™ç§æœ‰äº‘å­˜å‚¨ & æ°¸ä¹…å›¾åºŠç³»ç»Ÿ</b><br/>
  å°† Telegram é¢‘é“/ç¾¤ç»„ç¬é—´å˜èº«ä¸ºç§æœ‰ç½‘ç›˜ä¸å›¾åºŠï¼šæ–‡ä»¶ç®¡ç†ã€å¤–é“¾åˆ†äº«ã€å›¾ç‰‡æ‰˜ç®¡ï¼Œä¸€ç«™å¼æå®šã€‚
</p>

<p align="center">
  <a href="#-ä¸€é”®è„šæœ¬æ¨è">å¿«é€Ÿå¼€å§‹</a> Â·
  <a href="#%EF%B8%8F-é¦–æ¬¡é…ç½®æ•™ç¨‹">é¦–æ¬¡é…ç½®</a> Â·
  <a href="#-åå‘ä»£ç†è¯´æ˜-caddynignx">åå‘ä»£ç†</a> Â·
  <a href="#-å¸¸è§é—®é¢˜æ’æŸ¥">å¸¸è§é—®é¢˜</a> Â·
  <a href="#-åŠŸèƒ½ç‰¹æ€§">åŠŸèƒ½ç‰¹æ€§</a> Â·
  <a href="#-å…è´£å£°æ˜ä¸åˆè§„ä½¿ç”¨é‡è¦">å…è´£å£°æ˜</a>
</p>

<p align="center">
  <img alt="Python" src="https://img.shields.io/badge/Python-3.11%2B-blue" />
  <img alt="Docker" src="https://img.shields.io/badge/Docker-required-2496ED" />
  <img alt="License" src="https://img.shields.io/badge/License-MIT-green" />
</p>

---

## âœ¨ é¡¹ç›®ç®€ä»‹

**tgstate-python** åˆ©ç”¨ Telegram çš„äº‘ç«¯èƒ½åŠ›å®ç°â€œæ— é™å®¹é‡â€çš„ä¸ªäººæ–‡ä»¶ç®¡ç†ä¸åˆ†äº«ç³»ç»Ÿï¼š

- **æ— é™å­˜å‚¨**ï¼šæ–‡ä»¶è½åœ°åˆ°ä½ è‡ªå·±çš„ Telegram é¢‘é“/ç¾¤ç»„ï¼ˆä¸å æœåŠ¡å™¨ç¡¬ç›˜ï¼‰
- **å¤–é“¾åˆ†äº«**ï¼šç”ŸæˆçŸ­é“¾æ¥ï¼ˆ`/d/AbC123`ï¼‰ï¼Œå¯ç›´æ¥ä¸‹è½½/é¢„è§ˆ
- **å›¾åºŠæ‰˜ç®¡**ï¼šä¸€é”®å¤åˆ¶ Markdown/HTML é“¾æ¥ï¼Œé€‚é… PicGo
- **Web ç®¡ç†**ï¼šæ‹–æ‹½ä¸Šä¼ ã€åˆ—è¡¨ç®¡ç†ã€æƒé™ä¿æŠ¤

> âš ï¸ æ³¨æ„ï¼šæœ¬é¡¹ç›®å®šä½ä¸º **ä¸ªäººå­¦ä¹ /ç§ç”¨å·¥å…·**ï¼Œè¯·é˜…è¯»æ–‡æœ«å…è´£å£°æ˜ä¸åˆè§„è¯´æ˜ã€‚

---

## ğŸš€ ä¸€é”®è„šæœ¬ï¼ˆæ¨èï¼‰

> ğŸ’¡ è„šæœ¬æ‰§è¡Œæ—¶ä¼šæç¤ºè¾“å…¥ç«¯å£ï¼ˆå›è½¦é»˜è®¤ `8000`ï¼‰ã€‚  
> ä¹Ÿå¯é€šè¿‡ç¯å¢ƒå˜é‡è·³è¿‡äº¤äº’ï¼š`PORT=15767 BASE_URL=https://...`

### 1) ä¸€é”®å®‰è£… / ä¸€é”®æ›´æ–°ï¼ˆä¿ç•™æ•°æ®ï¼Œæ¨èï¼‰
```bash
bash -lc 'bash <(curl -fsSL https://raw.githubusercontent.com/buyi06/tgstate-python/main/scripts/install.sh)'

2) ä¸€é”®é‡å»ºå®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼Œä¸“æ²»å®¹å™¨è·‘é£ï¼‰

bash -lc 'bash <(curl -fsSL https://raw.githubusercontent.com/buyi06/tgstate-python/main/scripts/reset.sh)'

3) ä¸€é”®å½»åº•æ¸…ç†ï¼ˆæ¸…ç©ºæ•°æ®ï¼Œä¸å¯é€†ï¼‰

bash -lc 'bash <(curl -fsSL https://raw.githubusercontent.com/buyi06/tgstate-python/main/scripts/purge.sh)'


---

âš™ï¸ é¦–æ¬¡é…ç½®æ•™ç¨‹

éƒ¨ç½²åé¦–æ¬¡è®¿é—® Webï¼Œä¼šè¿›å…¥ å¼•å¯¼é¡µ è®¾ç½®ç®¡ç†å‘˜å¯†ç ã€‚
å®Œæˆåè¿›å…¥ ç³»ç»Ÿè®¾ç½® å¡«å†™æ ¸å¿ƒé…ç½®ã€‚


---

Step 1ï¼šè·å– BOT_TOKEN

1. Telegram æœç´¢å¹¶æ‰“å¼€ @BotFatherï¼Œç‚¹å‡»â€œå¼€å§‹â€


2. å‘é€ /newbot


3. æŒ‰æç¤ºè¾“å…¥ Name ä¸ Usernameï¼ˆç”¨æˆ·åå¿…é¡»ä»¥ bot ç»“å°¾ï¼‰


4. BotFather å›å¤ä¸­çš„
Use this token to access the HTTP API:
ä¸‹æ–¹é‚£ä¸²å­—ç¬¦å³ä¸º BOT_TOKEN




---

Step 2ï¼šè·å– Chat IDï¼ˆCHANNEL_NAMEï¼‰

1) å‡†å¤‡é¢‘é“/ç¾¤ç»„

æ–°å»ºä¸€ä¸ªé¢‘é“æˆ–ç¾¤ç»„ï¼ˆå…¬å¼€/ç§å¯†å‡å¯ï¼‰

å…³é”®ï¼šæŠŠæœºå™¨äººæ‹‰è¿›å»å¹¶è®¾ç½®ä¸ºç®¡ç†å‘˜ï¼ˆç¡®ä¿å¯è¯»/å¯å‘ï¼‰


2) è·å– ID

åœ¨ç¾¤/é¢‘é“é‡Œéšä¾¿å‘ä¸€æ¡æ–‡æœ¬æ¶ˆæ¯

æµè§ˆå™¨è®¿é—®ï¼š https://api.telegram.org/bot<ä½ çš„Token>/getUpdates

å°† <ä½ çš„Token> æ›¿æ¢ä¸ºçœŸå® BOT_TOKEN


åœ¨è¿”å› JSON ä¸­æ‰¾åˆ°ï¼šchat.id

é€šå¸¸ä»¥ -100 å¼€å¤´ï¼Œä¾‹å¦‚ -1001234567890



3) å…¬å¼€é¢‘é“çš„æ›¿ä»£å†™æ³•

å¦‚æœæ˜¯å…¬å¼€é¢‘é“ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¡«ï¼š@my_channel_name


> ğŸ’¡ è‹¥ getUpdates è¿”å›ç©ºï¼ˆ"result": []ï¼‰ï¼Œé€šå¸¸æ˜¯ä»¥ä¸‹åŸå› ä¹‹ä¸€ï¼š

æ¶ˆæ¯æ²¡è§¦å‘åˆ° botï¼šå¤šå‘å‡ æ¡æ¶ˆæ¯å†è¯•

Group Privacy å¼€ç€ï¼šåˆ° @BotFather â†’ /mybots â†’ é€‰æ‹©æœºå™¨äºº â†’ Bot Settings â†’ Group Privacy â†’ Turn off





---

Step 3ï¼šå¡«å†™ç³»ç»Ÿè®¾ç½®

è¿›å…¥ Web çš„ ç³»ç»Ÿè®¾ç½®ï¼ŒæŒ‰ä¸‹é¢å¡«å†™ï¼š

BOT_TOKENï¼šStep 1 è·å¾—

CHANNEL_NAMEï¼šStep 2 è·å¾—ï¼ˆæ¨èæ•°å­— IDï¼‰

BASE_URLï¼ˆå¯é€‰ï¼‰ï¼šç”¨äºå¯¹å¤–åˆ†äº«çš„åŸŸåæˆ– IP

ç¤ºä¾‹ï¼šhttp://1.2.3.4:8000 æˆ– https://pan.example.com

è¯´æ˜ï¼šä¸å¡«ä¹Ÿèƒ½è‡ªåŠ¨ç”Ÿæˆå¯ç”¨åˆ†äº«é“¾æ¥ï¼›è‹¥ä½¿ç”¨åå‘ä»£ç†ï¼Œä¸ºäº† Bot å›å¤é“¾æ¥æ›´å‡†ç¡®ï¼Œå»ºè®®å¡«å†™



ä¿å­˜åå³å¯å¼€å§‹ä½¿ç”¨ã€‚


---

ğŸŒ åå‘ä»£ç†è¯´æ˜ (Caddy/Nginx)

1) Cookie ä¸ HTTPS

ç³»ç»Ÿå·²ä¼˜åŒ– Cookie ç­–ç•¥ï¼Œå¯åœ¨ HTTP(IP:Port) ä¸ HTTPS ç¯å¢ƒä¸‹è‡ªåŠ¨é€‚é…ã€‚
è‹¥åä»£å±‚å¼€å¯ HTTPSï¼Œè¯·ç¡®ä¿è¯·æ±‚å¤´æ­£ç¡®é€ä¼ ã€‚


---

2) Caddy é…ç½®ç¤ºä¾‹

buyi.us.ci {
    encode gzip
    reverse_proxy 127.0.0.1:8000
}


---

3) Nginx é…ç½®ç¤ºä¾‹ï¼ˆæ¨èé€ä¼  Host ä¸ X-Forwarded-*ï¼‰

location / {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}


---

â“ å¸¸è§é—®é¢˜æ’æŸ¥

Q1ï¼šç™»å½•åè·³å›ç™»å½•é¡µ / æ— æ³•ç™»å½• / 500 é”™è¯¯

å¯†ç å­—ç¬¦æ”¯æŒï¼šå·²ä¿®å¤ Cookie å­˜å‚¨é—®é¢˜ï¼Œæ”¯æŒä¸­æ–‡/ç©ºæ ¼/Emoji ç­‰ä»»æ„å¼ºå¯†ç 

500 Internal Server Errorï¼šå¤šè§äºæ—§ç‰ˆæœ¬æœªæ­£ç¡®å¤„ç†ç‰¹æ®Šå­—ç¬¦ Cookie

å¤„ç†æ–¹å¼ï¼šæ¸…é™¤æµè§ˆå™¨ Cookie æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼



æ’æŸ¥ä¸é‡ç½®ï¼š

æŸ¥çœ‹æ—¥å¿—ï¼š

docker logs tgstate --tail 200

é‡ç½®æ•°æ®å·ï¼ˆâš ï¸ ä¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼‰ï¼š

docker rm -f tgstate; docker volume rm tgstate-data; docker volume create tgstate-data


è¡¥å……æ£€æŸ¥ï¼š

è®¾ç½®å¯†ç æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨å»é™¤é¦–å°¾ç©ºæ ¼ï¼Œè¯·ç¡®è®¤è¾“å…¥ä¸€è‡´

IP è®¿é—®æ—¶è¯·ç¡®è®¤æµè§ˆå™¨æœªç¦ç”¨ Cookieï¼ˆå¯ç‚¹åœ°å€æ å›¾æ ‡æŸ¥çœ‹ Cookie æ˜¯å¦å†™å…¥ï¼‰

é«˜çº§é‡ç½®ï¼šå¯åˆ é™¤ data/file_metadata.db ä¸­ app_settings è¡¨è®°å½•ï¼ˆéœ€è¦æ‡‚ SQLï¼‰ï¼Œæˆ–åˆ é™¤æ•°æ®åº“æ–‡ä»¶ï¼ˆä¼šä¸¢å¤±ç´¢å¼•ï¼Œä¸æ¨èï¼‰



---

Q2ï¼šé€€å‡ºç™»å½•ç‚¹å‡»æ— ååº”æˆ–æŠ¥é”™

é€€å‡ºç™»å½•ä½¿ç”¨ JS å¼¹çª—ç¡®è®¤ï¼Œè¯·ç¡®ä¿é¡µé¢ JS æ­£å¸¸åŠ è½½ï¼ˆæµè§ˆå™¨æ§åˆ¶å°æ— æŠ¥é”™ï¼‰

å¦‚æç¤ºç½‘ç»œé”™è¯¯ï¼Œåˆ·æ–°é¡µé¢é‡è¯•



---

Q3ï¼šå¤åˆ¶é“¾æ¥å¤±è´¥

é HTTPSï¼ˆHTTP IP è®¿é—®ï¼‰å¯èƒ½è¢«æµè§ˆå™¨é™åˆ¶å‰ªè´´æ¿ API

ç³»ç»Ÿå·²å†…ç½®å›é€€ï¼šè‡ªåŠ¨å¤åˆ¶å¤±è´¥ä¼šå¼¹çª—æ˜¾ç¤ºé“¾æ¥ä¾›æ‰‹åŠ¨å¤åˆ¶

å»ºè®®å¯ç”¨ HTTPS åä»£ä»¥è·å¾—æœ€ä½³ä½“éªŒ



---

Q4ï¼šåˆ é™¤æ–‡ä»¶ååˆ—è¡¨ä¸åˆ·æ–°

åˆ é™¤ä¸ºå¼‚æ­¥æ“ä½œï¼Œå¶å‘ç½‘ç»œå»¶è¿Ÿ

åˆ·æ–°é¡µé¢å³å¯ï¼›è‹¥ä»å­˜åœ¨ï¼Œå¤šä¸ºåˆ é™¤å¤±è´¥ï¼ˆå¸¸è§åŸå› ï¼šBot æƒé™ä¸è¶³/éç®¡ç†å‘˜ï¼‰



---

Q5ï¼šåˆ†äº«é“¾æ¥æ˜¯ 127.0.0.1

å‰ç«¯ä¼šæ ¹æ®â€œä½ å½“å‰è®¿é—®é¡µé¢çš„åœ°å€â€è‡ªåŠ¨ç”Ÿæˆåˆ†äº«é“¾æ¥

è‹¥ä½ é€šè¿‡ 127.0.0.1 è®¿é—®ï¼Œç”Ÿæˆçš„è‡ªç„¶ä¹Ÿæ˜¯ 127.0.0.1

ç”¨å…¬ç½‘ IP æˆ–åŸŸåè®¿é—®å³å¯è‡ªåŠ¨å˜æ›´ä¸ºå¯¹åº”åœ°å€



---

ğŸ“‚ åŠŸèƒ½ç‰¹æ€§

æ— é™å­˜å‚¨ï¼šä¾èµ– Telegram é¢‘é“/ç¾¤ç»„ï¼Œå®¹é‡æ— ä¸Šé™

çŸ­é“¾æ¥åˆ†äº«ï¼š/d/AbC123ï¼Œè‡ªåŠ¨é€‚é…å½“å‰è®¿é—®åŸŸå

æ‹–æ‹½ä¸Šä¼ ï¼šæ”¯æŒæ‰¹é‡æ‹–æ‹½ä¸Šä¼ ï¼Œå¤§æ–‡ä»¶è‡ªåŠ¨åˆ†å—

å›¾åºŠæ¨¡å¼ï¼šMarkdown/HTML ä¸€é”®å¤åˆ¶ï¼Œé€‚é… PicGo

éšç§å®‰å…¨ï¼šæ–‡ä»¶è½åœ¨ä½ çš„ç§æœ‰é¢‘é“ï¼›Web æ”¯æŒå¯†ç ä¿æŠ¤



---

ğŸ“º åœ¨çº¿é¢„è§ˆ / å¼ºåˆ¶ä¸‹è½½ / Range è¯´æ˜ï¼ˆéªŒæ”¶å‘½ä»¤ï¼‰

ç³»ç»Ÿå¯¹åˆ†äº«é“¾æ¥ï¼ˆ/d/{id}ï¼‰æä¾›äº†æ™ºèƒ½çš„ Content-Disposition ä¸æµå¼æ”¯æŒï¼š

1. é»˜è®¤ç­–ç•¥

å¯é¢„è§ˆç±»å‹ï¼ˆå›¾ç‰‡/PDF/æ–‡æœ¬/ä»£ç /éŸ³è§†é¢‘ï¼‰ï¼šContent-Disposition: inline

ä¸å¯é¢„è§ˆç±»å‹ï¼ˆå‹ç¼©åŒ…/äºŒè¿›åˆ¶ç­‰ï¼‰ï¼šContent-Disposition: attachment



2. å¼ºåˆ¶ä¸‹è½½

é“¾æ¥è¿½åŠ  ?download=1ï¼ˆä¾‹å¦‚ /d/GNW2KH?download=1ï¼‰
æ— è®ºç±»å‹ä¸€å¾‹è¿”å› attachment



3. Range æ”¯æŒï¼ˆéŸ³è§†é¢‘ï¼‰

å¯¹ video/*ã€audio/* æ”¯æŒ HTTP Range

è¿”å› 206 Partial Contentã€Accept-Ranges: bytesã€Content-Range

æ”¯æŒæ’­æ”¾å™¨æ‹–åŠ¨è¿›åº¦æ¡ä¸æ–­ç‚¹ç»­ä¼ 



4. HEAD æ”¯æŒ

æ”¯æŒ HEADï¼Œè¿”å›ä¸ GET ä¸€è‡´çš„å…³é”® Headersï¼ˆå¤§å°/ç±»å‹ç­‰ï¼‰



5. æµè§ˆå™¨å…¼å®¹æ€§æç¤º

ä¸åŒæµè§ˆå™¨å¯¹ PDF/è§†é¢‘ç¼–ç ï¼ˆHEVC/MKVï¼‰æ”¯æŒä¸åŒ

é¢„è§ˆå¤±è´¥æ—¶å¯ç”¨ ?download=1 ä¸‹è½½æˆ–æ›´æ¢ Chrome/Edge





---

ğŸš€ ä¸€é”®éªŒæ”¶å‘½ä»¤

åœ¨ Linux/macOS ç»ˆç«¯è¿è¡Œï¼ŒéªŒè¯å“åº”å¤´æ˜¯å¦ç¬¦åˆé¢„æœŸï¼ˆæ›¿æ¢ BASE_URL ä¸ IDï¼‰ï¼š

bash -lc '
set -euo pipefail
# è¯·ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„åŸŸåå’Œæ–‡ä»¶ID
BASE="${BASE_URL:-https://pan.777256.xyz}"
ID="${ID:-GNW2KH}"
URL="${BASE%/}/d/${ID}"

# è·å–æœ€ç»ˆè·³è½¬åœ°å€ï¼ˆå¤„ç†å¯èƒ½çš„ HTTP->HTTPS é‡å®šå‘ï¼‰
FINAL="$(curl -sS -L -o /dev/null -w "%{url_effective}" --max-time 15 "$URL" || true)"; [ -n "$FINAL" ] || FINAL="$URL"

echo "URL=$URL"
echo "FINAL=$FINAL"
echo

echo "== 1. HEAD è¯·æ±‚ (åº”è¿”å› 200/206ï¼Œä¸åº”æ˜¯ 405) =="
curl -sS -I --max-time 15 "$FINAL" | egrep -i "HTTP/|content-type|content-disposition|accept-ranges|content-range|content-length|x-content-type-options" || true
echo

echo "== 2. Default GET (å¯é¢„è§ˆç±»å‹åº” inline; ä¸å¯é¢„è§ˆåº” attachment) =="
curl -sS -L -D - -o /dev/null --max-time 20 "$FINAL" | egrep -i "HTTP/|content-type:|content-disposition:|accept-ranges:|content-range:|content-length:|x-content-type-options:" || true
echo

echo "== 3. GET ?download=1 (å¿…é¡» attachment) =="
curl -sS -L -D - -o /dev/null --max-time 20 "$FINAL?download=1" | egrep -i "HTTP/|content-type:|content-disposition:" || true
echo

echo "== 4. Range bytes=0-1023 (éŸ³è§†é¢‘åº” 206 + Content-Range) =="
curl -sS -L -D - -o /dev/null --max-time 20 -H "Range: bytes=0-1023" "$FINAL" | egrep -i "HTTP/|accept-ranges:|content-range:|content-length:" || true
'

âœ… éªŒæ”¶é€šè¿‡æ ‡å‡†ï¼š

HEADï¼š200ï¼ˆæˆ– 302 å 200ï¼‰ï¼Œä¸”åŒ…å« Content-Type ç­‰å¤´

Defaultï¼šPDF/å›¾ç‰‡åº” inline

Downloadï¼š?download=1 æ—¶å¿…é¡» attachment

Rangeï¼šéŸ³è§†é¢‘åº” 206 Partial Content ä¸”æœ‰ Content-Range



---

å…è´£å£°æ˜ä¸åˆè§„ä½¿ç”¨ï¼ˆé‡è¦ï¼‰

æœ¬é¡¹ç›®åŸºäº Telegram Bot + é¢‘é“/ç¾¤ç»„ å®ç°ä¸ªäººæ–‡ä»¶ç®¡ç†/åˆ†äº«èƒ½åŠ›ï¼š

Telegram çš„ Bot å¹³å°æ¡æ¬¾å¯¹â€œç”¨äºäº‘å­˜å‚¨ç±»å¤–éƒ¨æœåŠ¡â€å­˜åœ¨é™åˆ¶ä¸é£é™©

æœ¬é¡¹ç›® ä»…ä¾›å­¦ä¹ ä¸ä¸ªäººç”¨é€”

ä¸¥ç¦ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

ä¾µæƒå†…å®¹ï¼ˆç›—ç‰ˆèµ„æºã€æœªæˆæƒè½¬è½½/ä¼ æ’­ç­‰ï¼‰

ä»»ä½•è¿æ³•ç”¨é€”

å…¬å¼€èµ„æºåˆ†å‘/å…¬å…±ä¸‹è½½ç«™

å•†ä¸šç½‘ç›˜/å¯¹å¤–æä¾›å­˜å‚¨æœåŠ¡



ä½¿ç”¨æœ¬é¡¹ç›®äº§ç”Ÿçš„ä»»ä½•åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ï¼›å¼€å‘è€…ä¸å¯¹ç”±æ­¤é€ æˆçš„å°å·ã€æ•°æ®ä¸¢å¤±ã€æ³•å¾‹é£é™©ç­‰è´Ÿè´£ã€‚


---

ğŸ“„ License

MIT License